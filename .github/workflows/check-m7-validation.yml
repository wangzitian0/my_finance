name: M7 Test Validation Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read

jobs:
  validation-check:
    name: "Check M7 Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: "Checkout"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: "M7 Validation - All 4 Core Conditions"
      run: |
        set -e
        
        echo "ğŸ” M7éªŒè¯å¼€å§‹ - æ£€æŸ¥4ä¸ªæ ¸å¿ƒæ¡ä»¶..."
        echo "1. âœ… è·‘äº†æµ‹è¯•"
        echo "2. â° æµ‹è¯•é€šè¿‡çš„ç»“æŸæ—¶é—´åœ¨pushæ—¶é—´10åˆ†é’Ÿä¹‹å†…"
        echo "3. ğŸ“… pushæ—¶é—´åœ¨24hå†…"
        echo "4. ğŸ“Š CIä¸Šè·‘ç®€æ˜“æµ‹è¯•æ˜¯é€šçš„"
        echo ""
        
        # è·å–commitä¿¡æ¯
        COMMIT_MSG=$(git log -1 --pretty=%B)
        COMMIT_TIME=$(git log -1 --pretty=%ct)
        CURRENT_TIME=$(date +%s)
        
        echo "ğŸ“ Commitæ¶ˆæ¯:"
        echo "$COMMIT_MSG"
        echo "---"
        echo "ğŸ“… Commitæ—¶é—´: $(date -d @$COMMIT_TIME -u)"
        echo "ğŸ“… å½“å‰æ—¶é—´: $(date -u)"
        echo ""
        
        # æ£€æŸ¥1: è·‘äº†æµ‹è¯•
        echo "ğŸ” æ£€æŸ¥1: æ˜¯å¦è¿è¡Œäº†M7æµ‹è¯•"
        if echo "$COMMIT_MSG" | grep -q "M7-TESTED.*This commit passed M7 end-to-end testing"; then
            echo "âœ… æ£€æŸ¥1é€šè¿‡: æ‰¾åˆ°M7æµ‹è¯•æ ‡è®°"
        else
            echo "âŒ æ£€æŸ¥1å¤±è´¥: æ²¡æœ‰æ‰¾åˆ°M7æµ‹è¯•æ ‡è®°"
            echo "   æœŸæœ›æ¨¡å¼: M7-TESTED: This commit passed M7 end-to-end testing"
            echo ""
            echo "ğŸ“ ä¿®å¤æ­¥éª¤:"
            echo "   1. è¿è¡Œ: pixi run test-m7-e2e"
            echo "   2. ä½¿ç”¨: pixi run create-pr \"æ ‡é¢˜\" ISSUE_NUMBER"
            exit 1
        fi
        echo ""
        
        # æ£€æŸ¥2: æµ‹è¯•æ—¶é—´åœ¨10åˆ†é’Ÿå†…
        echo "ğŸ” æ£€æŸ¥2: æµ‹è¯•æ—¶é—´éªŒè¯ (10åˆ†é’Ÿå†…)"
        TEST_TIME_LINE=$(echo "$COMMIT_MSG" | grep "ğŸ• Test Time:" | head -1)
        if [ -z "$TEST_TIME_LINE" ]; then
            echo "âŒ æ£€æŸ¥2å¤±è´¥: æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ—¶é—´"
            exit 1
        fi
        
        # æå–ISOæ—¶é—´æˆ³
        TEST_TIME_ISO=$(echo "$TEST_TIME_LINE" | sed 's/.*Test Time: //' | grep -o '[0-9T:Z-]*')
        if [ -z "$TEST_TIME_ISO" ]; then
            echo "âŒ æ£€æŸ¥2å¤±è´¥: æ— æ³•æå–æµ‹è¯•æ—¶é—´æˆ³"
            exit 1
        fi
        
        # è½¬æ¢ä¸ºepochæ—¶é—´ (ä½¿ç”¨Pythonç¡®ä¿è·¨å¹³å°å…¼å®¹)
        TEST_TIME_EPOCH=$(python3 -c "
import datetime
try:
    dt = datetime.datetime.fromisoformat('$TEST_TIME_ISO'.replace('Z', '+00:00'))
    print(int(dt.timestamp()))
except:
    print('0')
")
        
        if [ "$TEST_TIME_EPOCH" -eq 0 ]; then
            echo "âŒ æ£€æŸ¥2å¤±è´¥: æ— æ³•è§£ææµ‹è¯•æ—¶é—´"
            exit 1
        fi
        
        # è®¡ç®—æ—¶é—´å·®
        TIME_DIFF=$((COMMIT_TIME - TEST_TIME_EPOCH))
        TIME_DIFF_MIN=$((TIME_DIFF / 60))
        
        echo "   æµ‹è¯•æ—¶é—´: $TEST_TIME_ISO"
        echo "   æ—¶é—´å·®: ${TIME_DIFF}ç§’ (${TIME_DIFF_MIN}åˆ†é’Ÿ)"
        
        if [ "$TIME_DIFF" -gt 600 ]; then  # 10åˆ†é’Ÿ
            echo "âŒ æ£€æŸ¥2å¤±è´¥: æµ‹è¯•æ—¶é—´å¤ªæ—© (${TIME_DIFF_MIN}åˆ†é’Ÿå‰)"
            echo "   æµ‹è¯•å¿…é¡»åœ¨commitå‰10åˆ†é’Ÿå†…å®Œæˆ"
            echo "   è¿™é˜²æ­¢åœ¨ä»£ç ä¿®æ”¹åä½¿ç”¨è¿‡æ—¶çš„æµ‹è¯•ç»“æœ"
            exit 1
        elif [ "$TIME_DIFF" -lt -120 ]; then  # -2åˆ†é’Ÿ
            echo "âŒ æ£€æŸ¥2å¤±è´¥: æµ‹è¯•æ—¶é—´å¤ªæ™š (${TIME_DIFF_MIN}åˆ†é’Ÿå)"
            echo "   è¿™è¡¨æ˜æ—¶é’ŸåŒæ­¥é—®é¢˜æˆ–æ— æ•ˆæ—¶é—´æˆ³"
            exit 1
        else
            echo "âœ… æ£€æŸ¥2é€šè¿‡: æµ‹è¯•æ—¶é—´åœ¨åˆç†èŒƒå›´å†…"
            if [ "$TIME_DIFF" -lt 0 ]; then
                echo "   æ³¨æ„: æµ‹è¯•åœ¨commitåè¿è¡Œ (å¸¸è§äº--amendæ“ä½œ)"
            fi
        fi
        echo ""
        
        # æ£€æŸ¥3: commitåœ¨24å°æ—¶å†…
        echo "ğŸ” æ£€æŸ¥3: commitæ–°é²œåº¦éªŒè¯ (24å°æ—¶å†…)"
        COMMIT_AGE=$((CURRENT_TIME - COMMIT_TIME))
        COMMIT_AGE_HOURS=$((COMMIT_AGE / 3600))
        
        echo "   Commitå¹´é¾„: ${COMMIT_AGE}ç§’ (${COMMIT_AGE_HOURS}å°æ—¶)"
        
        if [ "$COMMIT_AGE" -gt 86400 ]; then  # 24å°æ—¶
            echo "âŒ æ£€æŸ¥3å¤±è´¥: commitå¤ªæ—§ (${COMMIT_AGE_HOURS}å°æ—¶å‰)"
            echo "   Commitå¿…é¡»åœ¨24å°æ—¶å†…"
            echo "   è¯·åˆ›å»ºæ–°çš„commitå¹¶é‡æ–°æµ‹è¯•"
            exit 1
        else
            echo "âœ… æ£€æŸ¥3é€šè¿‡: commitåœ¨24å°æ—¶å†… (${COMMIT_AGE_HOURS}å°æ—¶å‰)"
        fi
        echo ""
        
        # æ£€æŸ¥4: æµ‹è¯•ç»“æœå……è¶³
        echo "ğŸ” æ£€æŸ¥4: æµ‹è¯•ç»“æœéªŒè¯ (M7æ•°æ®å……è¶³æ€§)"
        if echo "$COMMIT_MSG" | grep -q "Test Results.*data files validated"; then
            FILE_COUNT=$(echo "$COMMIT_MSG" | grep "Test Results:" | grep -o '[0-9]*' | head -1)
            echo "   å‘ç°æµ‹è¯•ç»“æœ: ${FILE_COUNT:-0} ä¸ªæ•°æ®æ–‡ä»¶"
            
            if [ -n "$FILE_COUNT" ] && [ "$FILE_COUNT" -ge 7 ]; then
                echo "âœ… æ£€æŸ¥4é€šè¿‡: éªŒè¯äº†${FILE_COUNT}ä¸ªæ•°æ®æ–‡ä»¶ (â‰¥7)"
            else
                echo "âŒ æ£€æŸ¥4å¤±è´¥: æ•°æ®æ–‡ä»¶ä¸è¶³ (${FILE_COUNT:-0} < 7)"
                echo "   M7æµ‹è¯•éœ€è¦è‡³å°‘7ä¸ªå…¬å¸çš„æ•°æ®æ–‡ä»¶"
                exit 1
            fi
        else
            echo "âŒ æ£€æŸ¥4å¤±è´¥: æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•ç»“æœ"
            echo "   æœŸæœ›æ¨¡å¼: Test Results: X data files validated"
            exit 1
        fi
        echo ""
        
        # æˆåŠŸæ€»ç»“
        echo "ğŸ‰ æ‰€æœ‰4ä¸ªæ ¸å¿ƒæ¡ä»¶æ£€æŸ¥é€šè¿‡!"
        echo "âœ… 1. è¿è¡Œäº†M7æµ‹è¯•"
        echo "âœ… 2. æµ‹è¯•æ—¶é—´åœ¨10åˆ†é’Ÿå†…"
        echo "âœ… 3. Commitåœ¨24å°æ—¶å†…"
        echo "âœ… 4. æµ‹è¯•ç»“æœå……è¶³"
        echo ""
        echo "ğŸš€ è¿™ä¸ªPRå¯ä»¥å®‰å…¨åˆå¹¶!"
        
        # GitHub Actionsæ‘˜è¦
        echo "## âœ… M7éªŒè¯æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æ‰€æœ‰4ä¸ªæ ¸å¿ƒæ¡ä»¶éƒ½æ»¡è¶³:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **M7æµ‹è¯•è¿è¡Œ**: æ‰¾åˆ°æµ‹è¯•éªŒè¯æ ‡è®°" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **æµ‹è¯•æ—¶é—´**: åœ¨commitå‰${TIME_DIFF_MIN}åˆ†é’Ÿ (â‰¤10åˆ†é’Ÿ)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Commitæ–°é²œåº¦**: ${COMMIT_AGE_HOURS}å°æ—¶å‰ (â‰¤24å°æ—¶)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **æµ‹è¯•ç»“æœ**: ${FILE_COUNT}ä¸ªæ•°æ®æ–‡ä»¶éªŒè¯ (â‰¥7)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸš€ **è¿™ä¸ªPRå·²å‡†å¤‡å¥½åˆå¹¶!**" >> $GITHUB_STEP_SUMMARY