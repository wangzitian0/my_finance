name: M7 Test Validation Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read

jobs:
  validation-check:
    name: "Check M7 Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: "Checkout"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: "Check M7 Test Validation in Commit Message"
      run: |
        echo "üîç Checking for M7 test validation in commit message..."
        
        # Get the latest commit message
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "üìù Latest commit message:"
        echo "$COMMIT_MSG"
        echo "---"
        
        # Check for M7-TESTED marker
        if echo "$COMMIT_MSG" | grep -q "M7-TESTED.*This commit passed M7 end-to-end testing"; then
          echo "‚úÖ Found M7 test validation in commit message"
          
          # Check for test results
          if echo "$COMMIT_MSG" | grep -q "Test Results.*data files validated"; then
            echo "‚úÖ Found test results information"
            echo "‚úÖ M7 validation check PASSED"
          else
            echo "‚ùå FAIL: Test results information not found in commit message"
            echo "   Expected: Test Results: X data files validated"
            exit 1
          fi
        else
          echo "‚ùå FAIL: M7 test validation not found in commit message"
          echo "   This PR was not created with 'pixi run create-pr'"
          echo "   Expected pattern: 'M7-TESTED: This commit passed M7 end-to-end testing'"
          echo ""
          echo "üìù Required steps:"
          echo "   1. Run locally: pixi run test-m7-e2e"
          echo "   2. Use: pixi run create-pr \"Your title\" ISSUE_NUMBER"
          exit 1
        fi