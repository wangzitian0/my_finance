name: "ğŸ” M7 Quality Gate Validation"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read

jobs:
  validation-check:
    name: "ğŸ“Š M7 Quality Gate (5 Conditions)"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: "Checkout"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: "Setup Python"
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: "ğŸ” M7 Quality Gate Validation"
      run: |
        echo "ğŸ¯ ==============================================="
        echo "ğŸ¯ M7 QUALITY GATE VALIDATION"
        echo "ğŸ¯ ==============================================="
        echo ""
        echo "ğŸ“‹ Checking 5 core quality conditions:"
        echo "   1. âœ… Test Execution     - F2 fast test OR M7 complete test"
        echo "   2. â° Test Timing       - Tests run within 10 minutes of push"  
        echo "   3. ğŸ“… Commit Freshness  - Push within 24 hours of creation"
        echo "   4. ğŸ“Š Test Results      - Sufficient data files validated"
        echo "   5. ğŸ¨ Code Formatting   - Python code follows black + isort standards"
        echo ""
        echo "ğŸ”§ Running validation script..."
        echo ""
        
        python3 ci_m7_validation.py || {
          echo ""
          echo "ğŸš¨ ==============================================="
          echo "ğŸš¨ M7 QUALITY GATE FAILED"
          echo "ğŸš¨ ==============================================="
          echo ""
          echo "âŒ Your pull request does not meet the minimum quality standards."
          echo "ğŸš« This PR cannot be merged until all conditions are satisfied."
          echo ""
          echo "ğŸ”§ QUICK FIX - Follow this exact sequence:"
          echo "   1. p3 check                         # Fix formatting issues"
          echo "   2. p3 test f2                       # Run F2 fast test (2-5 min)"
          echo '   3. p3 ship "Brief description" ISSUE# # Update PR with validation'
          echo ""
          echo "âš¡ ALTERNATIVE - For comprehensive testing:"
          echo "   1. p3 check                         # Fix formatting issues"  
          echo "   2. p3 test m7                       # Run M7 complete test (10-20 min)"
          echo '   3. p3 ship "Brief description" ISSUE# # Update PR with validation'
          echo ""
          echo "âŒ THESE METHODS WILL ALWAYS FAIL:"
          echo "   â€¢ Manual git push/commit commands"
          echo "   â€¢ GitHub web UI PR creation"
          echo "   â€¢ Hand-crafted test markers"
          echo ""
          echo "ğŸ’¡ WHY: The automated workflow embeds cryptographic test evidence"
          echo "   that cannot be manually replicated. This prevents fake test results."
          echo ""
          echo "ğŸ“– Need help? Check .github/README.md â†’ CI/CD Troubleshooting"
          echo ""
          exit 1
        }
        
        echo ""
        echo "ğŸ‰ ===============================================" 
        echo "ğŸ‰ M7 QUALITY GATE PASSED!"
        echo "ğŸ‰ ==============================================="
        echo ""
        echo "âœ… All quality conditions satisfied"
        echo "âœ… PR is ready for review and merge"
        echo "âœ… Automated testing workflow was followed correctly"