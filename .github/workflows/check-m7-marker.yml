name: Check M7 Test Marker

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

concurrency:
  group: m7-marker-check-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-m7-marker:
    name: "M7 Local Test Verification (MANDATORY)"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: "üì• Checkout code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Only need latest commit
        
    - name: "üîç Check M7 Test Marker"
      id: check_marker
      run: |
        echo "üîç Checking for M7 test marker file..."
        
        if [ ! -f ".m7-test-passed" ]; then
          echo "‚ùå FAIL: M7 test marker file not found"
          echo "   This PR was not created with 'pixi run create-pr' or M7 test did not pass locally"
          echo ""
          echo "üìù Required steps:"
          echo "   1. Run locally: pixi run test-m7-e2e"
          echo "   2. Ensure test passes and creates .m7-test-passed file"
          echo "   3. Use: pixi run create-pr \"Your title\" ISSUE_NUMBER"
          echo ""
          exit 1
        fi
        
        echo "‚úÖ M7 test marker found"
        
        # Read and validate marker file
        echo "üìã M7 Test Details:"
        cat .m7-test-passed
        
        # Extract key information (trim whitespace)
        COMMIT_HASH=$(grep "COMMIT_HASH=" .m7-test-passed | cut -d'=' -f2 | tr -d ' \t\n\r')
        TEST_TIMESTAMP=$(grep "TEST_TIMESTAMP=" .m7-test-passed | cut -d'=' -f2 | tr -d ' \t\n\r')
        M7_DATA_FILES=$(grep "M7_DATA_FILES=" .m7-test-passed | cut -d'=' -f2 | tr -d ' \t\n\r')
        VALIDATION_PASSED=$(grep "VALIDATION_PASSED=" .m7-test-passed | cut -d'=' -f2 | tr -d ' \t\n\r')
        
        echo ""
        echo "üîç Validation Results:"
        echo "   üìä M7 Data Files: $M7_DATA_FILES"
        echo "   ‚úÖ Validation Status: $VALIDATION_PASSED"
        echo "   ‚è±Ô∏è  Test Time: $TEST_TIMESTAMP"
        echo "   üìù Commit Hash: $COMMIT_HASH"
        
        # Debug validation check
        echo "üîç Debug: VALIDATION_PASSED='$VALIDATION_PASSED'"
        echo "üîç Debug: Length=${#VALIDATION_PASSED}"
        
        # Verify validation passed
        if [ "$VALIDATION_PASSED" != "true" ]; then
          echo "‚ùå FAIL: M7 validation did not pass (got: '$VALIDATION_PASSED')"
          exit 1
        fi
        
        # Check if we have sufficient data files
        if [ "$M7_DATA_FILES" -lt 7 ]; then
          echo "‚ùå FAIL: Insufficient M7 data files ($M7_DATA_FILES < 7)"
          exit 1
        fi
        
        echo "‚úÖ M7 local test verification PASSED"
        echo "‚úÖ This PR is ready for human review"
        
    - name: "üìù Comment on PR (Success)"
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ‚úÖ M7 Local Test Verification PASSED
            
            This PR includes a valid M7 test marker, indicating that:
            
            - üß™ **M7 End-to-End Test**: Completed successfully on developer machine
            - üìä **Data Validation**: All expected M7 files present locally
            - üèóÔ∏è **Build Process**: Completed without errors
            - ‚ö° **Fast Verification**: No heavy CI/CD resources used
            
            The PR was created using the proper workflow: \`pixi run create-pr\`
            
            This PR is **ready for human review** üöÄ
            
            *M7 testing completed locally - no expensive cloud resources used!*`
          })
          
    - name: "üìù Comment on PR (Failure)"  
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ‚ùå M7 Local Test Verification FAILED
            
            This PR **cannot be merged** because it lacks a valid M7 test marker.
            
            **Required actions:**
            1. Run locally: \`pixi run test-m7-e2e\` 
            2. Ensure test passes (creates .m7-test-passed file)
            3. Recreate PR with: \`pixi run create-pr "Your title" ISSUE_NUMBER\`
            
            **Why this approach?**
            - ‚ö° **Fast**: No expensive GitHub Actions runners
            - üè† **Local**: Tests run on your development environment  
            - üíö **Efficient**: Saves CI/CD resources for actual deployment
            - üîí **Quality**: Still enforces M7 validation requirement
            
            ‚ùå **This PR is BLOCKED until M7 validation passes locally**`
          })