name: Fast Test Pipeline (F2)

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]

env:
  # F2 Fast CI testing with DeepSeek 1.5b
  DCF_FAST_MODE: true
  CI_FAST_TESTING: true
  CI_SCOPE: "f2"

jobs:
  f2-fast-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Increased from 1 minute to handle F2 builds
    
    steps:
    - name: "ðŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        submodules: false
        
    - name: "ðŸ“¦ Setup Pixi Environment"  
      uses: prefix-dev/setup-pixi@v0.8.1
      with:
        pixi-version: v0.50.2
        
    - name: "ðŸ—ï¸ Setup F2 Test Infrastructure"
      run: |
        echo "ðŸš€ Setting up F2 fast build infrastructure for CI"
        # Create required directories for F2 testing
        mkdir -p build_data/{stage_00_raw,stage_01_daily_delta,stage_04_query_results}
        mkdir -p common/config logs
        
        # Create F2 configuration files
        cat > common/config/list_fast_2.yml << EOF
        # F2 Fast Testing - 2 companies for CI validation
        dataset_name: fast_2
        cli_alias: f2
        description: "Fast 2 companies for development and CI testing"
        companies:
          - ticker: MSFT
            name: "Microsoft Corporation"
            cik: "0000789019"
          - ticker: NVDA  
            name: "NVIDIA Corporation"
            cik: "0001045810"
        EOF
        
        # Create mock DeepSeek configuration for CI
        mkdir -p common/config/llm/configs
        cat > common/config/llm/configs/deepseek_fast.yml << EOF
        llm_service:
          provider: "mock_ci"
          model: "deepseek-r1:1.5b"
          fast_mode: true
        dcf_generation:
          enable_sec_integration: false
          timeout: 30
        EOF
        
    - name: "ðŸ§ª Run F2 Fast Build Test"
      id: f2_test
      run: |
        echo "ðŸš€ Running F2 fast build test optimized for CI"
        echo "Expected: F2 scope (MSFT + NVDA) with DeepSeek 1.5b model"
        
        # Use p3 e2e f2 for proper F2 fast testing
        timeout 8m pixi run python p3.py e2e f2 || {
          echo "âŒ F2 fast build test failed or timed out"
          echo "This indicates either:"
          echo "  1. F2 build system issues"
          echo "  2. Infrastructure problems"  
          echo "  3. Test timeout (should complete in <8 minutes)"
          exit 1
        }
        
        echo "âœ… F2 fast build test completed successfully"
        
    - name: "ðŸ“Š Validate F2 Test Results"
      run: |
        echo "ðŸ” Validating F2 test results and data files"
        
        # Check for F2 data files (should have at least 2 files for MSFT + NVDA)
        f2_files=$(find build_data -name "*.json" -type f | wc -l)
        echo "ðŸ“ Found $f2_files F2 data files"
        
        if [ "$f2_files" -lt 2 ]; then
          echo "âŒ FAIL: Expected at least 2 F2 data files (MSFT + NVDA), found $f2_files"
          echo "This indicates F2 build did not complete successfully"
          exit 1
        fi
        
        echo "âœ… F2 validation passed: $f2_files data files confirmed"
        
    - name: "ðŸ§¹ Test Environment Cleanup"
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up F2 test artifacts"
        # Cleanup only CI-generated artifacts, preserve source code
        rm -rf build_data/stage_04_query_results/build_*
        echo "âœ… F2 test cleanup completed"
        
    - name: "ðŸ“‹ Store Test Artifacts"
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: f2-test-failure-artifacts
        path: |
          logs/
          build_data/stage_04_query_results/
        retention-days: 3