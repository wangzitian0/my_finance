name: Fast Test Pipeline (F2)

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]

env:
  # F2 Fast CI testing with DeepSeek 1.5b
  DCF_FAST_MODE: true
  CI_FAST_TESTING: true
  CI_SCOPE: "f2"

jobs:
  f2-fast-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Increased from 1 minute to handle F2 builds
    
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        submodules: false
        
    - name: "ğŸ“¦ Setup Pixi Environment"  
      uses: prefix-dev/setup-pixi@v0.8.1
      with:
        pixi-version: v0.50.2
        
    - name: "ğŸ—ï¸ Setup F2 Test Infrastructure"
      run: |
        echo "ğŸš€ Setting up F2 fast build infrastructure for CI"
        # Create required directories for F2 testing
        mkdir -p build_data/{stage_00_raw,stage_01_daily_delta,stage_04_query_results}
        mkdir -p common/config logs
        
        # Create F2 configuration files
        cat > common/config/list_fast_2.yml << EOF
        # F2 Fast Testing - 2 companies for CI validation
        dataset_name: fast_2
        cli_alias: f2
        description: "Fast 2 companies for development and CI testing"
        companies:
          - ticker: MSFT
            name: "Microsoft Corporation"
            cik: "0000789019"
          - ticker: NVDA  
            name: "NVIDIA Corporation"
            cik: "0001045810"
        EOF
        
        # Create mock DeepSeek configuration for CI
        mkdir -p common/config/llm/configs
        cat > common/config/llm/configs/deepseek_fast.yml << EOF
        llm_service:
          provider: "mock_ci"
          model: "deepseek-r1:1.5b"
          fast_mode: true
        dcf_generation:
          enable_sec_integration: false
          timeout: 30
        EOF
        
    - name: "ğŸ§ª Run F2 Fast Build Test"
      id: f2_test
      run: |
        echo "ğŸš€ Running F2 fast build test optimized for CI"
        echo "Expected: F2 scope (MSFT + NVDA) with DeepSeek 1.5b model"
        
        # Set environment variables for CI testing
        export DCF_FAST_MODE=true
        export CI_FAST_TESTING=true
        
        # Use the same command that works locally
        echo "ğŸ”§ Running: pixi run python p3.py e2e f2"
        timeout 8m pixi run python p3.py e2e f2 2>&1 | tee f2_test_output.log || {
          echo "âŒ F2 fast build test failed or timed out"
          echo "ğŸ“‹ Last 20 lines of output:"
          tail -n 20 f2_test_output.log || echo "No log file found"
          
          echo ""
          echo "ğŸ” Debugging information:"
          echo "  1. F2 build system issues"
          echo "  2. Infrastructure problems"  
          echo "  3. Test timeout (should complete in <8 minutes)"
          
          # Show directory structure for debugging
          echo ""
          echo "ğŸ“ Current directory structure:"
          ls -la build_data/ || echo "build_data directory not found"
          
          exit 1
        }
        
        echo "âœ… F2 fast build test completed successfully"
        echo "ğŸ“‹ Final 10 lines of F2 test output:"
        tail -n 10 f2_test_output.log || echo "No log output to show"
        
    - name: "ğŸ“Š Validate F2 Test Results"
      run: |
        echo "ğŸ” Validating F2 test results and data files"
        
        # Check for F2 data files in the correct location (yfinance data directory)
        if [ -d "build_data/stage_01_daily_delta/yfinance" ]; then
          f2_files=$(find build_data/stage_01_daily_delta/yfinance -type f | wc -l)
          echo "ğŸ“ Found $f2_files F2 data files in yfinance directory"
        else
          echo "ğŸ“ yfinance directory not found, checking general build_data"
          f2_files=$(find build_data -name "*.json" -o -name "*.csv" -o -name "*.txt" | grep -v ".git" | wc -l)
          echo "ğŸ“ Found $f2_files general data files"
        fi
        
        # Check build status using the same logic as the main test
        echo "ğŸ” Checking build completion status"
        build_status=$(pixi run python -c "
from common.build_tracker import BuildTracker
try:
    bt = BuildTracker.get_latest_build()
    status = bt.get_build_status() if bt else 'No builds found'
    print(status)
except Exception as e:
    print(f'Error: {e}')
" 2>/dev/null || echo "Build tracker not available")
        
        echo "ğŸ“Š Build status: $build_status"
        
        # More lenient validation for CI - just check that build completed
        if [[ "$build_status" == *"completed"* ]] || [[ "$build_status" == *"SUCCESS"* ]]; then
          echo "âœ… F2 validation passed: Build completed successfully"
        elif [ "$f2_files" -ge 1 ]; then
          echo "âœ… F2 validation passed: Found $f2_files data files (acceptable for CI)"
        else
          echo "âŒ FAIL: No evidence of successful F2 build completion"
          echo "Build status: $build_status"  
          echo "Files found: $f2_files"
          echo "This indicates F2 build did not complete successfully"
          exit 1
        fi
        
    - name: "ğŸ§¹ Test Environment Cleanup"
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up F2 test artifacts"
        # Cleanup only CI-generated artifacts, preserve source code
        rm -rf build_data/stage_04_query_results/build_*
        echo "âœ… F2 test cleanup completed"
        
    - name: "ğŸ“‹ Store Test Artifacts"
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: f2-test-failure-artifacts
        path: |
          logs/
          build_data/stage_04_query_results/
        retention-days: 3