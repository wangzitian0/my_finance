#!/bin/bash
# Git post-merge hook for P3 version auto-update
#
# This hook automatically updates P3 version after successful git pull/merge operations.
# To install: cp scripts/git-hooks/post-merge .git/hooks/post-merge && chmod +x .git/hooks/post-merge

# Only run if this was a merge from pull (not a merge commit)
if [ "$1" = "1" ]; then
    exit 0
fi

# Get the project root (handle worktrees)
if [ -f ".git" ]; then
    # This is a worktree
    MAIN_GIT_DIR=$(cat .git | sed 's/gitdir: //')
    PROJECT_ROOT=$(dirname "$MAIN_GIT_DIR" | sed 's|/.git/worktree/.*||')
else
    PROJECT_ROOT=$(git rev-parse --show-toplevel)
fi

# Check if P3 version management is available
if [ -f "$PROJECT_ROOT/p3_version.py" ]; then
    echo "ðŸ”„ Auto-updating P3 version after git pull..."
    cd "$PROJECT_ROOT"
    
    if python3 p3_version.py update-on-pull > /dev/null 2>&1; then
        NEW_VERSION=$(python3 p3_version.py info 2>/dev/null | grep "P3 Tool Version:" | cut -d' ' -f4)
        if [ ! -z "$NEW_VERSION" ]; then
            echo "âœ… P3 version updated to: $NEW_VERSION"
        fi
    fi
fi