---
# init.yml - Main Ansible Playbook
# This playbook sets up the complete local development environment.
# It delegates application dependencies to Pixi and handles system-level
# setup, which exclusively uses Docker for Neo4j.

- name: Initial Environment Setup
  hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    # The project directory, discovered from the environment.
    repo_dir: "{{ lookup('env','PWD') }}"
    # Docker container configuration
    neo4j_container_name: "my-finance-neo4j"
    neo4j_image_name: "neo4j:5.18-community"

  tasks:
    - name: Check if current directory is a Git repository
      stat:
        path: "{{ repo_dir }}/.git"
      register: git_repo
      become: false

    - name: Fail if current directory is not a Git repository
      fail:
        msg: "The setup must be run from the root of the Git repository. Current directory: {{ repo_dir }}"
      when: not git_repo.stat.exists
      become: false

    - name: Setup Pixi application environment
      include_tasks: roles/pixi_setup.yml

    - name: Setup dependency caching
      include_tasks: roles/dependency_cache.yml

    - name: Setup and start Podman with Neo4j
      include_tasks: roles/podman_setup.yml

    - name: Initialize or update data repository symlink
      include_tasks: roles/repo_data.yml

    - name: Final summary
      debug:
        msg: |
          ðŸŽ‰ Ansible setup complete!
          
          Your environment is configured. Here's a summary:
          
          - âœ… Pixi environment is ready.
          - âœ… Data repository is linked: repo/data -> ../my_finance_data
          - âœ… Podman is running with Neo4j container deployed.
          
          Next Steps:
          1. Activate the environment: `pixi shell`
          2. Run key tasks:
             - `p3 status` (check data status)
             - `p3 podman status` (check containers)
             - `p3 neo4j logs` (check Neo4j logs)
             - `p3 build run m7` (build a small test dataset)
          
          Access Neo4j:
          - Web Interface: http://localhost:7474
          - Bolt: bolt://localhost:7687 (neo4j/finance123)
